#!/usr/bin/env bash

# shellcheck shell=bash

################################################################################
#
# Uses GNU parallel to parallelize many github operations.
# Useful for collections of repositories or org wide things.
#
# http://www.gnu.org/savannah-checkouts/gnu/bash/manual/bash.html#Shell-Functions
# man parallel_tutorial
# The command can be a script, a binary or
# ---> a Bash function if the function is exported using export -f
#################################################################################

######################################################################
#<
#
# Function: p6_usage(rc=0, msg=)
#
#  Args:
#   rc -
#   msg -
#
#>
######################################################################
p6_usage() {
  local rc="${1:-0}"
  local msg="${2:-}"

  if [ -n "$msg" ]; then
    echo >&2 "$msg"
  fi
  cat <<EOF
Usage:
  gh parallel -h
  gh parallel [-j <jobs>] [--dry-run] clone <login> <dest_dir>

Commands:
  clone   Clone all repositories for a user or organization

Global Options:
  -h              Show this help message
  -j, --jobs <n>  Number of parallel jobs (default: 3)
  --dry-run       Show what would be done without executing
EOF
  exit "$rc"
}

######################################################################
#<
#
# Function: p6main(...)
#
#  Args:
#  ... -
#
#>
######################################################################
P6_PARALLEL_JOBS=3
P6_DRY_RUN=false

p6main() {
  # sanitize env
  LC_ALL=C

  # parse global options
  while [[ $# -gt 0 ]]; do
    case "$1" in
    -h | --help)
      p6_usage 0 "help"
      ;;
    -j | --jobs)
      P6_PARALLEL_JOBS="$2"
      if ! [[ "$P6_PARALLEL_JOBS" =~ ^[0-9]+$ ]] || [ "$P6_PARALLEL_JOBS" -lt 1 ]; then
        p6_usage 1 "invalid jobs value: $P6_PARALLEL_JOBS"
      fi
      shift 2
      ;;
    --dry-run)
      P6_DRY_RUN=true
      shift
      ;;
    -*)
      p6_usage 1 "unknown option: $1"
      ;;
    *)
      break
      ;;
    esac
  done

  # grab command
  local cmd="${1:-}"
  if [ -z "$cmd" ]; then
    p6_usage 1 "command required"
  fi
  shift 1

  # security 101: only allow valid commands
  case $cmd in
  help) p6_usage ;;
  clone) ;;
  *) p6_usage 1 "invalid cmd" ;;
  esac

  # exit if any cli errors w/ >0 return code
  # the commands can still disable locally if needed
  set -e
  p6_cmd_"${cmd}" "$@"
  set +e

  return 0
}

######################################################################
#<
#
# Function: p6_cmd_list(login)
#
#  Args:
#	  login -
#
#>
######################################################################
p6_cmd_list() {
  local login="$1"

  gh repo list "$login" -L 5000 | awk '{print $1}' | sort
}

######################################################################
#<
#
# Function: p6_cmd_clone(login, dir)
#
#  Args:
#	  login -
#	  dir -
#
#>
######################################################################
p6_cmd_clone() {
  local login="$1"
  local dir="$2"

  if [ $# -ne 2 ]; then
    p6_usage 1 "invalid arguments"
  fi

  local combos
  combos=$(p6_cmd_list "$login")

  if [ -z "$combos" ]; then
    p6_usage 1 "invalid organization/user"
  fi

  if [ ! -d "$dir" ]; then
    echo "mkdir -p $dir"
    mkdir -p "$dir"
  fi

  local login_dir
  login_dir="$dir/$login"

  local repo_count
  repo_count=$(echo "$combos" | wc -l | tr -d ' ')
  echo "Found $repo_count repositories"

  if [ "$P6_DRY_RUN" = true ]; then
    echo "[dry-run] Would clone $repo_count repositories with $P6_PARALLEL_JOBS parallel jobs:"
    echo "$combos"
    return 0
  fi

  # shellcheck disable=SC2086
  parallel --bar --jobs "$P6_PARALLEL_JOBS" -m p6_github_clone_parallel "$login_dir" ::: $combos
}

######################################################################
#<
#
# Function: p6_github_clone_parallel(login_dir, ...)
#
#  Args:
#	  login_dir -
#	  ... -
#
#>
######################################################################
p6_github_clone_parallel() {
  local login_dir="$1"
  shift 1

  local combo
  for combo in "$@"; do
    local repo
    repo=$(echo "$combo" | cut -d / -f 2)
    local dest_dir="$login_dir/$repo"

    if [ -d "$dest_dir" ]; then
      local cmd
      cmd="(cd \"$dest_dir\" && gh repo sync >/dev/null 2>&1)"
      eval "$cmd"
    else
      mkdir -p "$dest_dir"
      local cmd
      cmd="(cd \"$login_dir\" && gh repo clone \"$combo\" >/dev/null 2>&1)"
      eval "$cmd"
    fi
  done
}
export -f p6_github_clone_parallel

######################################################################
#<
#
# Function: p6main(...)
#
#  Args:
#	  ... -
#
#>
######################################################################
p6main "$@"

